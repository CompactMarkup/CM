CM.NUL='\0',CM.LT='\x01',CM.AMP='\x02',CM.BR='\x03',CM.Input=class{constructor(a){a=a.split('\n').map((a)=>a.trimRight()).join(CM.NUL),CM.NUL!==a.charAt(a.length-1)&&(a+=CM.NUL),this._gen=function*(){for(const b of a)yield b}(),this._que=[],this.peek()}_next(){const a=this._gen.next();return a.done&&(a.value=CM.NUL),a}peek(a=0){for(;this._que.length<=a;)this._que.push(this._next());return this._que[a].value}next(){return this._que.length?this._que.shift().value:this._next().value}hasMore(){return this.peek(),!this._que[0].done}push(a){const b=a.split('').reverse();for(const d of b)this._que.unshift({done:!1,value:d})}skip(a=1){for(;0<a--;)this.next()}nextCont(a=null,b=!1,d=!1){if(!this.hasMore())return CM.NUL;const e=this.next();return b&&CM.NUL===e?d?'\n':' ':a===e&&this.isNul()?(this.skip(),' '):e}nextLine(){let a,b='';for(;CM.NUL!==(a=this.next());)b+=a;return b}isNumChar(a=0,b=!1){const d=this.peek(a);return'0'<=d&&'9'>=d}isIdentChar(a=0,b=!1){const d=this.peek(a);return'a'<=d&&'z'>=d||'A'<=d&&'Z'>=d||'0'<=d&&'9'>=d||'_'===d||!b&&'-'===d}isColon(a=0){return':'===this.peek(a)}isWhite(a=0){const b=this.peek(a);return' '===b||'\t'===b}isNul(a=0){return CM.NUL===this.peek(a)}skipWhite(){if(!this.isWhite())return!1;for(;this.isWhite();)this.next();return!0}skipRest(){for(;CM.NUL!==this.next(););}match(a,b=1,c=!1){let d=0;for(;a===this.peek(d);)++d;return b===d||c&&b<d?(this.skip(d),d):0}matchs(a){let b=0;for(const d of a)if(d!==this.peek(b++))return!1;return this.skip(b),!0}},CM.Parser=class{constructor(a){if(this.idx=a.toc.fil[a.pagePath+a.pageFile],void 0===this.idx)throw new Error('reload_home');this.out=a.page=new a.Page(a,this)}put(a){this.outTx+=a}parse(a){for(this.outTx='',this.chr={cmt:'#',h:'=',hr:'-',p:'.',ul:'-',ol:'*',pre:'~',sec:'-',cls:'.',hook:'{|}',hraw:'',esc:'\\',th:'[]',td:'()',b:'',em:'',u:'',sup:'',sub:'',code:'',macro:'',squo:'',dquo:''},this._chrs=[],this._inPre=!1,this._inPar=!1,this._inList=!1,this._inListItem=!1,this._inTable=!1,this._in={b:!1,em:!1,u:!1,sup:!1,sub:!1,code:!1,squo:!1,dquo:!1},this.hasPre=!1,this.hasMath=!1,this._sects=this._hooks=0,this._macros={},this.inp=new CM.Input(a);this.inp.hasMore();)if(this._inTable)this.tableLine();else if(this._inPre)this.maybePre();else if(this._inList&&this.maybeContinuation());else{const a=this.chr,b=this.inp.peek();if('@'===b)this.doPragma();else if(b===a.cmt)this.doComment();else if(b===a.h&&this.maybeHeader());else if((b===a.ul||b===a.ol)&&this.maybeList());else if(b===a.pre&&this.maybePre());else if(b===a.sec&&this.maybeSec());else if(b===a.hr&&this.maybeHr());else if(this.maybeEmptyLine());else this.doTopLine()}return this.endAll(),this.out.endMatter(),this.outTx}_parseSize(a){let b=a,c='',d=a.indexOf('x');return 0<=d&&(b=a.substr(0,d),c=a.substr(++d)),[b,c]}tableLine(){const a=this.inp,b=this.out,d=this.chr;if(a.match(d.sec,3))a.skipRest(),b.secEnd(),this._inTable=!1,--this._sects;else{b.tr();const[a,e]=d.th,[f,g]=d.td;for(let h;CM.NUL!==(h=this.nextCont());)d.esc===h?this.nextEsc():a===h?(b.th(this.cs(),this.whSize()),this.tableCell(e),b.secEnd()):f===h&&(b.td(this.cs(),this.whSize()),this.tableCell(g),b.secEnd());b.secEnd()}}tableCell(a){const b=this.chr,[d]=b.hook;for(let e;CM.NUL!==(e=this.nextCont());)if(b.esc===e)this.nextEsc();else if(d===e)this.out.put(this.doHook());else if(a===e)break;else this.doChar(e)}nextEsc(){const a=this.inp.next();'n'===a?this.out.br():this.out.put(a)}nextCont(a=!1){return this.inp.nextCont(this.chr.esc,0<this._hooks,a)}maybeContinuation(){return this._inList&&this.inp.skipWhite()&&(this.out.put(' '),this.doLine(),!0)}doPragma(){const a=this.inp;a.skip();const b=this.token();a.skipWhite();const c=this.token();a.skipWhite();const d=this.token(!0);if(!0!==this.out.pragma(b,c,d)){const e=this.chr;switch(b){case'push':{this._chrs.push(JSON.parse(JSON.stringify(e)));break}case'pop':{this._chrs.length&&(this.chr=this._chrs.pop());break}case'chr':switch(c){case'cmt':e.cmt=d;break;case'h':e.h=d;break;case'hr':e.hr=d;break;case'p':e.p=d;break;case'ul':e.ul=d;break;case'ol':e.ol=d;break;case'pre':e.pre=d;break;case'sec':e.sec=d;break;case'cls':e.cls=d;break;case'hook':e.hook=d;break;case'hraw':e.hraw=d;break;case'esc':e.esc=d;break;case'b':e.b=d;break;case'em':e.em=d;break;case'u':e.u=d;break;case'sup':e.sup=d;break;case'sub':e.sub=d;break;case'code':e.code=d;break;case'macro':e.macro=d;break;case'th':e.th=d;break;case'td':e.td=d;break;case'squo':e.squo=d;break;case'dquo':e.dquo=d;break;default:}a.skipRest();break;case'def':this._macros[c]=d;break;default:}}}doComment(){this.inp.skipRest()}maybeHeader(){const a=this.inp.match(this.chr.h,1,!0);return!!a&&(this.endFlow(),this.out.h(a,this.cs()),this.inp.skipWhite(),this.doLine(),this.out.secEnd(),!0)}maybeList(){const a=this.chr,b=this.inp,d=b.peek();if(a.ul!==d&&a.ol!==d||!b.isWhite(1)&&a.cls!==b.peek(1))return!1;const c=a.ul===b.next()?'u':'o',e=this.cs();return b.skipWhite(),c!==this._inList&&(this.endFlow(),this._inList=c,'u'==c?this.out.ul(e):this.out.ol(e)),this.endListItem(),this._inListItem=!0,this.out.li(),this.doLine(),!0}maybePre(){return this.inp.match(this.chr.pre,3)?(this._inPre?this.endPre():(this.endFlow(),this.hasPre=this._inPre=!0,this.out.pre(this.cs())),this.inp.skipRest(),!0):(this._inPre&&this.out.preLine(this.inp.nextLine()),!1)}maybeSec(){if(!this.inp.match(this.chr.sec,3))return!1;this.endFlow(),this.inp.skipWhite();let a=this.ident();const b=this.cs();return this.inp.skipRest(),a||!b.length&&this._sects||(a='div'),a?(++this._sects,'table'===a?(this._inTable=!0,this.out.table(b)):this.out.sec(a,b)):this._sects&&(this.endFlow(),this.out.secEnd(),--this._sects),!0}maybeHr(){return!!this.inp.match(this.chr.hr,4,!0)&&(this.endFlow(),this.out.hr(this.cs()),this.inp.skipRest(),!0)}maybeEmptyLine(){return!!this.inp.isNul()&&(this.endFlow(),this.inp.next(),!0)}endPar(){this._inPar&&this.out.secEnd(),this._inPar=!1}endList(){this.endListItem(),this._inList&&this.out.secEnd(),this._inList=!1}endListItem(){this._inListItem&&this.out.secEnd(),this._inListItem=!1}endPre(){this._inPre&&this.out.preEnd(),this._inPre=!1}endFlow(){this.b(!1),this.em(!1),this.endPar(),this.endList()}endAll(){for(this.endFlow(),this.endPre();this._sects;)this.out.secEnd(),--this._sects}doTopLine(){this.endList(),this.inp.match(this.chr.p)?(this.endPar(),this._inPar=!0,this.out.p(this.cs())):!this._inPar&&(this._inPar=!0,this.out.p()),this.doLine(),this.out.put(' ')}doLine(){const a=this.chr,[b]=a.hook;for(let d;CM.NUL!==(d=this.nextCont());)a.esc===d?this.nextEsc():b===d?this.out.put(this.doHook()):this.doChar(d)}doChar(a){const b=this.chr;a===b.b?this.b():a===b.em?this.em():a===b.code?this.code():a===b.u?this.u():a===b.sup?this.sup():a===b.sub?this.sub():a===b.squo?this.squo():a===b.dquo?this.dquo():a===b.macro?this.macro(this.ident()):this.out.put(a)}macro(a){const b=this._macros[a];void 0===b?this.out.error('macro',a):this.inp.push(b)}shortcut(a,b,c,d){null===d?a.call(this,!this._in[b]):(d?c.call(this.out):this._in[b]&&this.out.secEnd(),this._in[b]=d)}b(a=null){this.shortcut(this.b,'b',this.out.b,a)}em(a=null){this.shortcut(this.em,'em',this.out.em,a)}u(a=null){this.shortcut(this.u,'u',this.out.u,a)}code(a=null){this.shortcut(this.code,'code',this.out.code,a)}sup(a=null){this.shortcut(this.sup,'sup',this.out.sup,a)}sub(a=null){this.shortcut(this.sub,'sub',this.out.sub,a)}squo(a=null){this.shortcut(this.squo,'squo',this.out.squo,a)}dquo(a=null){this.shortcut(this.dquo,'dquo',this.out.dquo,a)}token(a=!1){let b='';for(;!this.inp.isNul()&&(a||!this.inp.isWhite());)b+=this.inp.next();return b.trim()}ident(a=!1){const b=this.inp;if(!b.isIdentChar(0,!0))return'';let c='';for(;b.isIdentChar();)c+=b.next();return a&&b.isColon()&&(c+=b.next()),c}whSize(){let a='',b='';const c=this.inp;if('='===c.peek()){for(c.skip();c.isNumChar();)a+=c.next();if('x'===c.peek())for(c.skip();c.isNumChar();)b+=c.next()}return[a,b]}cs(){const a=[];for(;this.inp.match(this.chr.cls);)a.push(this.ident());return a}_hookInner(){const a=this.chr,[b,c,d]=a.hook;for(let e;CM.NUL!==(e=this.nextCont());)if(a.esc===e)this.nextEsc();else if(b===e)this.out.put(this.doHook());else if(d===e)break;else this.out.put(e)}_mathHook(){const a=this.inp;if('$'!==a.peek()||'$'!==a.peek(1))return!1;a.skip(2);const b=this.chr.hook[2];let d,c='';for(;CM.NUL!==(d=this.nextCont())&&('$'!==d||'$'!==a.peek()||b!==a.peek(1));)c+=d;return a.skip(2),this.out.math(c),this.hasMath=!0,!0}_formattingHook(){const a=this.inp,b=this.out;switch(a.peek()){case'*':case'/':case'_':case'~':case'\'':case',':{switch(a.next()){case'*':b.b();break;case'/':b.em();break;case'_':b.u();break;case'~':b.code();break;case'\'':b.sup();break;case',':b.sub();break;default:}return this._hookInner(),b.secEnd(),!0}default:return!1;}}_hookedHook(){const a=this.inp;let b;switch(a.peek()){case':':case'#':case'$':b=a.next();break;default:b=this.ident(!0);}if(!b)return!1;const d=this.chr,[e,f,g]=d.hook,h=this.cs(),i=[];let j,c='';a.skipWhite();const k=d.hraw,l=k.length;for(let b=!1;;){if(l&&a.matchs(k)&&(b=!b),CM.NUL===(j=this.nextCont(b)))break;if(b)c+=j;else if(d.esc===j){const b=a.next();c+='n'===b?CM.BR:b}else if(e===j)c+=this.doHook();else if(f===j)i.push(c),c='';else if(g===j)break;else c+=j}return i.push(c),this.callHook(b,h,i),!0}_typoHook(){const a=this.out,b=this.chr,[d,e,f]=b.hook;let g,c='';for(;CM.NUL!==(g=this.nextCont());)if(b.esc===g)c+=g+this.inp.next();else if(d===g)c+=this.doHook();else if(f===g)break;else c+=g;const h={"=>":'\u21D2',"<=":'\u21D0',"=>/":'\u21D3',"<=/":'\u21D1',"->":'\uD83E\uDC52',"<-":'\uD83E\uDC50',"->/":'\uD83E\uDC53',"<-/":'\uD83E\uDC51',">":'\u25B8',"<":'\u25C2',">/":'\u25BE',"</":'\u25B4',">>":'\u25B6',"<<":'\u25C0',">>/":'\u25BC',"<</":'\u25B2',"->>":'\uD83E\uDC7A',"<<-":'\uD83E\uDC78',"->>/":'\uD83E\uDC7B',"<<-/":'\uD83E\uDC79',"--":'\u2013',"---":'\u2014'}[c];void 0===h?a.error('hook',c):a.put(h)}callHook(a,b,c){this.hook(a,b,(a)=>{if(void 0===a)return c.join('|');const b=[];for(let d,e=0;e<a;++e)d=e<c.length?c[e]:'',0===e&&(d=d.trimLeft()),b.push(d);return b})}doHook(){const a=this.out;return a.begCapture(),this._hooks++,this._mathHook()||this._formattingHook()||this._hookedHook()||this._typoHook(),--this._hooks,a.endCapture()}hook(a,b,c){if(!0!==this.out.hook(a,b,c))switch(a){case':':{let[a,d]=c(2);if(d.length)d.startsWith('//')&&(d='http:'+d);else if(a.startsWith('//'))d='http:'+a,a=a.substr(2);else{const[b,c]=this.out.tocTxLn2(a);d=a,b&&(a=b)}this.out.a(a,d,b);break}case'#':{const[a]=c(1);this.out.anchor(a.replace(/ /g,'_'));break}case'$':{const[a]=c(1),b=this._macros[a];void 0===b?this.out.error('macro',a):this.inp.push(b);break}case'img:':{const[a,d,e,f]=c(4),g=a.startsWith('//')?'http:'+a:a;this.out.img(g,this._parseSize(d),e,f,b);break}case'toc:':{const[a]=c(1),[d,e]=this.out.tocTxLn2(a);d&&(this.out.span(b),this.out.a(d,e),this.out.secEnd());break}case'prev:':case'next:':{const[d,e]=this.out.tocTxLn(!1,'prev:'===a?-1:1);if(d){const[a]=c(1);this.out.span(b),this.out.put(a),this.out.a(d,e),this.out.secEnd()}break}case'gh:':{const[a,d]=c(2);let e=d?d:a;e='https://github.com/'+e,b.push('gh'),this.out.a(a,e,b);break}case'wp:':{const[a,d]=c(2);let e=d?d:a;e=e.replace(/ /g,'_'),e='https://en.wikipedia.org/wiki/'+e,b.push('wp'),this.out.a(a,e,b);break}case'btn:':{const[a]=c(1);b.push('btn'),this.out.sec('span',b),this.out.put(a),this.out.secEnd();break}case'todo:':{const[a]=c(1);this.out.todo(a,b);break}case'ed:':{const[a,d]=c(2);this.out.ed(a,d,b);break}case'fn:':{const[a]=c(1);this.out.fn(a);break}case'html:':{const[a]=c(1);this.out.html(a);break}case'script:':{const[a]=c(1);this.out.script(a);break}default:{this.out.error('hook',a+' '+c());break}}}};