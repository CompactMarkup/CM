class HtmlPage{constructor(a,b){this.book=a,this.toc=a.toc,this.idx=b.idx,this.parser=b,this._capture=null,this._captures=[],this._fns=[],this._ends=[]}begCapture(){null!==this._capture&&this._captures.push(this._capture),this._capture=""}endCapture(){const a=this._capture;return this._capture=this._captures.length?this._captures.pop():null,a}tocTxLn(a,b){try{const c=a?0:this.idx,d=this.toc.lst[c+b];return[d[2],d[0]]}catch(a){return["",""]}}tocTxLn2(a){const b=a.lastIndexOf("#");return this.tocTxLn(!0,this.toc.ids[0<=b?a.slice(0,b):a])}endMatter(){if(this.hr(),this.parser.callHook("prev:",["left"],["Back: "]),this.parser.callHook("next:",["right"],["Next: "]),this.hr(["paper"]),this._fns.length){this.box(),this.put("Footnotes:"),this.ol(["none"]);for(const[a,b]of this._fns)this.li(),this.anchor("_fn"+a),this.putTag("a",[]," onclick=\"book.page.scrollTo('#fn"+a+"')\""),this.put("["+a+"]"),this.putEndTag("a"),this.put(" "+b)}}ed(a,b,c){book.isDebug?(c.push("ed"),this.span(c),this.span(["tx"]),this.put(a),this.secEnd(),this.span(["note"]),this.put(b),this.secEnd(),this.secEnd()):this.put(a)}fn(a){const b=this._fns.length+1;this._fns.push([b,a]),this.sup(),this.anchor("fn"+b),this.putTag("a",[]," onclick=\"book.page.scrollTo('#_fn"+b+"')\""),this.put(b),this.putEndTag("a"),this.secEnd()}html(a){this.putRaw(a)}script(script){eval(script)}anchor(a){this.putTag("a",[],this.attr("name",a)),this.putEndTag("a")}box(a=[]){a.push("box"),this.div(a)}br(){this.putTag("br",[],"",!0)}preLine(a){this.put(a),this.put("\n")}goto(a,b,c){const d=window.event;return!!(void 0!==d&&(d.ctrlKey||d.metaKey))||(top.postMessage(["goto",a,b,c],"*"),!1)}scrollTo(a){if(a){const b=document.querySelector(`a[name="${a.substr(1)}"]`);b&&b.scrollIntoView(!0)}}link(a){let b=a?this.toc.ids[a]:this.idx;if(void 0!==b){const a=this.toc.lst[b][1];return this.book.isStatic?this.book.pages+a:"?pg="+a}if(a.startsWith("/"))return this.book.root+a.substr(1);if(0<=a.indexOf("://"))return a;let c=a.indexOf(":");if(0>c)return this.book.pages+this.book.pagePath+a;const d=a.substr(0,c),e=a.substr(++c);if(b=this.toc.ids[d],void 0===b)return a;const f=this.toc.lst[b][1],g=f.substr(0,f.lastIndexOf("/"));return this.book.pages+g+"/"+e}gotoLink(a,b,c){return window===top?"":(a||(a=this.toc.lst[this.idx][0]),` onclick=${JSON.stringify(`return book.page.goto('${a}','${b}','${c}')`)}`)}put(a){if(null===this._capture){let b="";for(const d of a)b+=this._htmlEncode(d);this.parser.put(b)}else this._capture+=a}_htmlEncode(a){return"&"===a?"&amp;":"<"===a?"&lt;":a===CM.LT?"<":a===CM.AMP?"&":a===CM.BR?"<br/>":a}putRaw(a){if(null===this._capture)this.parser.put(a);else{let b="";for(const d of a)b+=this._rawEncode(d);this._capture+=b}}_rawEncode(a){return"<"===a?CM.LT:"&"===a?CM.AMP:a}attr(a,b){return b?` ${a}=${JSON.stringify(b)}`:""}_cls(a){return this.attr("class",a.length?a.join(" "):"")}error(a,b){book.isDebug&&(this.span(["error"]),this.put("(!!!>"+a+": "+b+"<!!!)"),this.secEnd())}todo(a,b){book.isDebug&&(b.push("todo"),this.span(b),this.put(a),this.secEnd())}math(a){this.span(["math"]),this.put(`(math((\\mathsf{${a}}))math)`),this.secEnd()}putTag(a,b=[],c="",d=!1){this.put(`${CM.LT}${a}${this._cls(b)}${c}${d?"/":""}>`)}putEndTag(a){this.put(`${CM.LT}/${a}>`)}sec(a,b=[],c=""){this.putTag(a,b,c),this._ends.push(`${CM.LT}/${a}>`)}div(a=[],b=""){this.sec("div",a,b)}secEnd(){this.put(this._ends.pop())}h(a,b=[]){this.sec(`h${a}`,b)}p(a=[]){this.sec("p",a)}b(){this.sec("b")}em(){this.sec("em")}u(){this.sec("u")}sup(){this.sec("sup")}sub(){this.sec("sub")}squo(){this.put("\u2018"),this._ends.push("\u2019")}dquo(){this.put("\u201C"),this._ends.push("\u201D")}ul(a=[]){this.sec("ul",a)}ol(a=[]){this.sec("ol",a)}li(){this.sec("li")}pre(a=[]){a.length||a.push("nohighlight"),this.sec("pre",a),this.sec("code",a)}preEnd(){this.secEnd(),this.secEnd()}code(){this.sec("code",["inline"])}hr(a=[]){this.putTag("hr",a,"",!0)}span(a=[]){this.sec("span",a)}table(a=[]){this.sec("table",a)}tr(){this.sec("tr")}_thd(a,b,c){const[d,e]=c;let f="";d&&(f+=` colspan="${d}"`),e&&(f+=` rowspan="${e}"`),this.sec(a,b,f)}th(a,b){this._thd("th",a,b)}td(a,b){this._thd("td",a,b)}button(a=[],b=""){const c=a.includes("toggle");c&&(b=`this.classList.toggle('down');${b}`),b&&(b=` onclick=${JSON.stringify(b)}`),this.sec("button",a,b)}img(b,c,d,e,f=[]){const[g,h]=c;e&&this.div(["caption"]);let i=this.attr("src",this.link(b))+this.attr("title",d);g&&(i+=this.attr("width",g)),h&&(i+=this.attr("height",h));const j=0<=f.indexOf("pop");if(j){const a=this.link(b),c=this.attr("onclick",`window.open('${a}','cm_pop','location=0, resizable=1, status=0, toolbar=0, menubar=0'); return false;`);this.putTag("a",[],c)}this.putTag("img",f,i),j&&this.putEndTag("a"),e&&(this.br(),this.put(e),this.secEnd())}a(a,b,c=[]){const d=0<=b.indexOf("://")||b.startsWith("//");d&&c.push("extern");const e=b.lastIndexOf("#");let f="";0<=e&&(a===b&&0===e&&(a=a.slice(1)),f=b.slice(e).replace(/ /g,"_"),b=b.slice(0,e));let g=this.attr("href",this.link(b)+f),h="";d&&(g+=this.attr("target",h="cm_book_extern")),g+=this.gotoLink(b,f,h),this.putTag("a",c,g),this.put(a),this.putEndTag("a")}pragma(a,b,c){const d=this.book.pragma;return!!(d&&d(a,b,c))}hook(a,b,c){const d=this.book.hook;return d&&d.apply(this,[a,b,c])}}book.Page=HtmlPage;